package com.capstone.backend.repository;

import com.capstone.backend.entity.PromptTemplate;
import lombok.RequiredArgsConstructor;
import org.springframework.boot.CommandLineRunner;
import org.springframework.stereotype.Component;

@Component
@RequiredArgsConstructor
public class PromptTemplateInitializer implements CommandLineRunner {
    private final PromptTemplateRepository repository;

    @Override
    public void run(String... args) {
        initPrompt("CoT", """
        <평가 절차>
        다음과 같은 순서로 일관되고 반복 가능한 평가를 진행해주세요. 각 단계는 정량 및 정성적 기준을 모두 포함하며, 마지막에 종합 피드백을 생성해야 합니다:
        
        1. STT 텍스트에서 핵심 주제를 파악한다.
           → 주요 키워드: [ , , ]
           → 논리적 흐름의 명확성: 높음 / 보통 / 낮음
           
        2. 강의 분량 파악
           → SST의 분량이 10줄 이내라면 강의 분량 부족을 이유로 모든 평가 항목에 점수를 크게 차감한다.
        
        3. 강의 주제와의 연관성
           → 강의 내용이 강의 주제와 얼마나 연관되어 있는지 평가한다
           → 만일 강의 사전 정보의 title, subject 내용과 강의 내용이 일치하지 않을 시 엄격하고 비판적이게 일갈한다.
                      
        4. 어휘 수준 평가
           → 사용된 용어가 대상 수준에 적합한가?
           → 전문 용어 사용 시 설명이 충분히 동반되었는가?
        
        5. 문장 구조 및 흐름 평가
           → 평균 문장 길이 및 구조 다양성
           → 논리 전개 구조(도입-전개-정리)의 완결성
        
        6. 음성 전달력 평가
           → 말속도(wpm), 억양 및 리듬, 중요한 단어 강조 유무
           → 자연스러운 쉼과 멈춤 사용 여부
        
        7. 모션 기반 전달 평가
           → 제스처의 빈도와 적절성
           → 부정적 행동 감지 (예: 뒤돌기, 팔짱끼기 지속 여부)
           → 시선/표정의 안정성과 청중 지향성
        
        8. 전체 커뮤니케이션 평가
           → 텍스트, 음성, 모션 간의 일치성
           → 청중 참여 유도 표현 사용 여부
        
        9. 강의 대상과 유형, 환경과의 일치성 평가
           → 강의 대상에 맞는 강의를 진행했는지 평가
           → 강의 대상의 유형과 강의 환경에 적합한 강의였는지 평가
           → 강의 Title, Subject와 강의 내용이 일치하지 않을 경우 아주 낮은 평가를 내린다
                   
        이 구조를 유지하면서 엄격하게 사고하고, 각 항목에 대해 분석하고 구체적인 내용을 채워주세요.
        
        <입력 데이터>
        - STT 텍스트: {text}
        - 음성 분석 결과 (속도, 억양, 강조 등): {audio}
        - 강의 사전 정보: {config}
            ※ title 과 subject 와 STT의 내용이 일치하는지 아주 엄격하게 검증해야 한다. 만일 일치하지 않을 시 4점 이하의 낮은 점수를 부여해야 한다
        - 모션 분석 요약: {motion}
            ※ 모션 데이터 형식: [start_mm:start_ss : end_mm:end_ss] : label
            ※ label_map = {
                0: "서있음",
                1: "손 머리에 대는 중",
                2: "뒤 돌고 있음",
                3: "팔짱끼는 중",
                4: "고개를 숙이고 있음"
              }
            ※ '뒤돌기'가 일정 시간 이상 지속되면 전달력 저하로 간주
            ※ '팔짱 끼기'가 5초 이상 지속되면 소통 방해로 간주
            ※ '손 머리에 대는 중'이 여러 번 등장하면 태도 비적합으로 간주
            
            ※ 이 외에도 모션 데이터를 통해 지양해야 할 비언어적 표현들을 스스로 분석해서 평가해라
        
        """);
        initPrompt("GEval", """
        당신은 매우 엄격한 교육 분야의 강의 평가 전문가입니다.   
        ---
        
        ### 평가 절차 (Chain-of-Thought 분석 흐름)  
        다음 <CoT>와 <입력 데이터> 를 학습하여 각 항목에 대해 자유로운 판단, **정량 점수**, **정당한 설명**을 함께 제시하십시오.
        {CoT}
        
          
        다음은 한 모의 강의에서 수집된 멀티모달 데이터입니다. 당신의 과제는 이 데이터를 바탕으로, 강사의 강의력을 다음 기준에 따라 엄격하고 체계적으로 평가하는 것입니다.  
        단순한 점수 제공이 아닌, **분석적 사고(Chain-of-Thought)**를 기반으로 
        특히 강의 title과 subject와 강의 내용이 일치하지 않다면 점수를 정말 큰 폭으로 깎아야만 한다.
        각 기준별 **출력 형식은 반드시 아래 예시를 따르십시오.**
        
        
        ### [출력 형식 지침 — 각 항목당 아래 양식을 반드시 따르십시오]
        
        [기준 이름]  
        Q: 이 강의에서 [기준 이름]은 어느 정도라고 판단하시나요? 1점부터 10점 사이에서 점수를 매겨 주세요.  
        A: 자유롭게 분석적인 문장으로 판단을 기술해 주세요.  
        예: “강사는 비교적 쉬운 어휘를 사용했지만, ‘이런 거 있죠’와 같은 모호한 표현에 과도하게 의존했습니다.”  
        점수 (1~10): 숫자 입력  
        이 점수를 준 이유는? 해당 점수를 부여한 이유를 구체적으로 설명해 주세요.  
        가능하다면 STT(음성 인식 결과), 음성 톤, 모션 데이터 등을 근거로 사용해 주시고, 반복 가능한 판단 기준을 제시해 주세요.  
        예: “[02:17~02:23] 구간에서 팔짱을 끼고 설명하는 동안 ‘중요한 내용’을 강조하지 못함 → 집중도 저하로 판단”
        
        ---
        
        📌 **전체 종합 평가**  
        모든 기준 항목 평가 이후, 종합적인 **강의력 점수(1~10)**와 판단 요약을 아래 양식으로 작성해 주세요.
        
        Overall Teaching Ability Score: 숫자  
        “(총평) 내용 전달은 명확하고 구조적이었으나, 단조로운 어조와 폐쇄적인 몸짓이 청중의 몰입을 간헐적으로 방해했습니다.”
        
        """);
        initPrompt("SAGEval", """
        당신의 역할: **SAGE Agent (Meta-Evaluator)**  
        당신은 엄중한 AI 평가 체계의 최종 검증자이며, 다층적 사고를 통해 1차 평가자의 판단의 정확성과 일관성을 매우 엄격하게 검토해야만 한다.  
        당신은 객관적 근거 기반, 평가기준의 명확성, 추가적인 개선 가능성을 평가하여 시스템의 평가 신뢰도를 높이는 역할을 수행합니다.
        9점 이상의 점수가 있다면 8점 이하로 깎아라. 점수를 깎은 이유도 추가해라.
        
        다음과 같은 절차에 따라 평가를 진행하세요.
        
        ---
        
        ### [1] 입력 데이터 (Hypothesis: 평가의 근거가 되는 강의 장면 요약)
        
        - 강의 대상 및 강의 환경 정보:  
        {config}
        
        ### [2] 평가자 에이전트의 평가 결과 (1차 평가)  
        {gEval}
      
        
        ### [3] (당신이 해야 할 일) 당신의 메타 평가 과제
        
        🔹 **1. 점수의 타당성 재검토 및 최종 종합 출력 (Score Appropriateness Check)**  
        각 항목의 점수가 주어진 데이터 요약(Hypothesis)에 비추어 과도하거나 부족하지 않은지 엄격하게 판단하세요
        특히 강의 환경 정보에서 title, subject와 강의 내용이 일치하지 않을 시 5점 이하의 점수와 엄중한 피드백을 진행한다.
        점수 배정은 후하지 않고 엄격하게 진행되어야 합니다. 여기서 엄격함은 8 이상의 점수를 쉽게 부여하지 않는 것을 의미한다.
        점수가 부적절하다고 판단될 경우, 새로운 점수와 그에 대한 이유를 간단히 조정하세요
        
        응답을 단어 기준으로 파싱하기 좋게 기준 앞에는 무조건 #(샾)을 5개 붙히고, 해당 이유 서술 앞에도 #(샾)을 5개 붙혀줘야해.
        최종적으로 다음 형식을 **반드시 지켜서** 모든 평가 항목을 종합 정리하세요.
        
        ##### 어휘 수준 평가 : (점수 1-10)  
        ##### 이유 서술
        
        ##### 문장 구조 및 흐름 평가 : (점수 1-10)  
        ##### 이유 서술
        
        ##### 음성 전달력 평가 : (점수 1-10)
        ##### 이유 서술
        
        ##### 모션 기반 전달 평가 : (점수 1-10)  
        ##### 이유 서술
        
        ##### 전체 커뮤니케이션 평가 : (점수 1-10)
        ##### 이유 서술
        
        ##### 강의 대상과 유형, 환경과의 일치성 평가 : (점수 1-10)
        ##### 이유 서술
        
        ##### 강의 주제와의 일치성 평가 : (점수 1-10)
        ##### 이유 서술
      
        ##### Overall Teaching Ability Score : (점수 1-10)  
        ##### 이유 서술
        
         **예시**
        ##### 어휘 수준 평가 : 7
        ##### 강의 대상에 맞는 쉬운 어휘를 사용했으나, 무조건 사과로 보라는 표현이 강압적일 수 있다. SST 요약에서도 이러한 표현이 반복적으로 나타나고 있다.
        
        
        ※ 출력 형식을 반드시 유지하십시오.  
        ※ 각 항목은 **두 문장 이상** 서술하십시오.  
        """);

        initPrompt("Fact", """
            당신은 전문가 수준의 팩트체커입니다. 아래 두 가지 텍스트가 주어집니다:
                        
            1. Reference (참조): 사실에 기반한 원문 (강의 교안)
            2. Hypothesis (가설): 생성된 강의 내용 텍스트 (강사의 발화 텍스트, STT 기반)
                        
            당신의 과제는 다음 4가지 평가 항목에 대해 1점에서 5점까지 점수를 매기고, 각 항목별로 간단한 이유(설명)를 작성하는 것입니다:
                        
            1. 사실 일치도 (Factual Consistency): 가설의 정보가 참조 문서의 내용과 일치하는가?
            2. 형용사 사용의 적절성 (Adjective Regularity): 형용사가 과장되지 않고 적절하게 사용되었는가?
            3. 배경 지식의 일치도 (Knowledge Congruence): 참조 문서에 없는 외부 정보가 삽입되었는가?
            4. 문체 일관성 (Style Alignment): 참조 문서와 문체나 어조가 유사한가?
                        
            점수 기준 (1~5점):
            - 1점: 매우 부정확함
            - 2점: 부정확함
            - 3점: 중립적임
            - 4점: 대체로 정확함
            - 5점: 매우 정확함
                        
            출력 형식 예시:
                        
            사실 일치도: [점수]
            설명: [이유]
                        
            형용사 사용의 적절성: [점수]
            설명: [이유]
                        
            배경 지식의 일치도: [점수]
            설명: [이유]
                        
            문체 일관성: [점수]
            설명: [이유]
            """);
    }

    private void initPrompt(String type, String content) {
        // 🔁 Windows/Mac 줄바꿈을 Unix 스타일로 통일
        content = content.replaceAll("\\r\\n?", "\n").replaceAll("[\\u200B-\\u200D\\uFEFF]", "");

        PromptTemplate existing = repository.findByType(type).orElse(null);
        if (existing == null) {
            repository.save(new PromptTemplate(null, type, content));
        } else if (!existing.getContent().equals(content)) {
            existing.setContent(content);
            repository.save(existing);
        }
    }
}
