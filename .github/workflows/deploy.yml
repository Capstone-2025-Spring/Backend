name: Deploy Backend to EC2

on:
  push:
    branches: [ main ]

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
      # 1. ì½”ë“œ ì²´í¬ì•„ì›ƒ
      - name: Checkout code
        uses: actions/checkout@v3

      # 2. GitHub Secretìœ¼ë¡œë¶€í„° application.yml ë³µì›
      - name: Restore application.yml from GitHub Secret
        run: |
          echo "${{ secrets.APPLICATION_YML }}" | sed 's/\\n/\n/g' > ./src/main/resources/application.yml

      # 3. JDK 21 ì„¤ì •
      - name: Set up JDK 21
        uses: actions/setup-java@v3
        with:
          java-version: '21'
          distribution: 'temurin'

      # 4. Gradle ì‹¤í–‰ ê¶Œí•œ ë¶€ì—¬
      - name: Grant execute permission for Gradle
        run: chmod +x ./gradlew

      # 5. Gradle ë¹Œë“œ (ìºì‹œ ë¬´íš¨í™” í¬í•¨)
      - name: Clean and Build with Gradle
        run: ./gradlew clean build

      # 6. ë¹Œë“œëœ JAR íŒŒì¼ í™•ì¸
      - name: Debug - JAR í™•ì¸
        run: ls -lh build/libs

      # 7. EC2 SSH í‚¤ íŒŒì¼ ì €ì¥
      - name: Save EC2 private key
        run: |
          echo "${{ secrets.EC2_KEY }}" > ec2-key.pem
          chmod 600 ec2-key.pem

      # 8. EC2ì— JAR ë³µì‚¬ (ì •í™•í•œ ìœ„ì¹˜ë¡œ)
      - name: Upload JAR to EC2
        run: |
          scp -i ec2-key.pem \
              -o StrictHostKeyChecking=no \
              build/libs/backend-0.0.1-SNAPSHOT.jar \
              ${{ secrets.EC2_USER }}@${{ secrets.EC2_HOST }}:/home/ec2-user/app/build/libs/backend-0.0.1-SNAPSHOT.jar

      # âœ… 9. Python ì„œë²„ ì½”ë“œ ì—…ë¡œë“œ (venv ì œì™¸, ê°•ì œ ë™ê¸°í™”)
      - name: Upload Python server code
        run: |
          rsync -avz --checksum --delete --exclude 'venv' ./python_server/ \
            -e "ssh -i ec2-key.pem -o StrictHostKeyChecking=no" \
            ${{ secrets.EC2_USER }}@${{ secrets.EC2_HOST }}:/home/ec2-user/python_server/
        

        # âœ… 10. Python ì˜ì¡´ì„± ì„¤ì¹˜ ë° ì„œë¹„ìŠ¤ ì¬ì‹œì‘
      - name: Restart Python server only (reuse venv)
        uses: appleboy/ssh-action@master
        with:
          host: ${{ secrets.EC2_HOST }}
          username: ${{ secrets.EC2_USER }}
          key: ${{ secrets.EC2_KEY }}
          script: |
            echo "ğŸ Python ì„œë²„ ì¬ì‹œì‘ (venv ì¬ì‚¬ìš©)"
            cd /home/ec2-user/python_server
            source venv/bin/activate
            sudo systemctl restart python.service

      # 11. Spring ë°±ì—”ë“œ ì„œë¹„ìŠ¤ ì¬ì‹œì‘
      - name: Restart backend service
        uses: appleboy/ssh-action@master
        with:
          host: ${{ secrets.EC2_HOST }}
          username: ${{ secrets.EC2_USER }}
          key: ${{ secrets.EC2_KEY }}
          script: |
            echo "ğŸ›  Spring ì„œë¹„ìŠ¤ ì¬ì‹œì‘"
            sudo systemctl daemon-reexec
            sudo systemctl restart lecture.service

      # 12. âœ… EC2ì˜ JAR íƒ€ì„ìŠ¤íƒ¬í”„ í™•ì¸
      - name: âœ… EC2ì˜ JAR íƒ€ì„ìŠ¤íƒ¬í”„ í™•ì¸
        uses: appleboy/ssh-action@master
        with:
          host: ${{ secrets.EC2_HOST }}
          username: ${{ secrets.EC2_USER }}
          key: ${{ secrets.EC2_KEY }}
          script: |
            echo "ğŸ—‚ ìµœì‹  JAR ì •ë³´:"
            ls -lh /home/ec2-user/app/build/libs/backend-0.0.1-SNAPSHOT.jar

      # âœ… 13. Python ì£¼ìš” íŒŒì¼ SHA256 í™•ì¸
      - name: ğŸ“„ Python ì½”ë“œ SHA256 ì²´í¬ì„¬ í™•ì¸
        uses: appleboy/ssh-action@master
        with:
          host: ${{ secrets.EC2_HOST }}
          username: ${{ secrets.EC2_USER }}
          key: ${{ secrets.EC2_KEY }}
          script: |
            echo "ğŸ” app.py SHA256:"
            sha256sum /home/ec2-user/python_server/app.py || echo "âš ï¸ app.py ì—†ìŒ"
            echo "ğŸ” run_captioning.py SHA256:"
            sha256sum /home/ec2-user/python_server/video_caption_generator/run_captioning.py || echo "âš ï¸ run_captioning.py ì—†ìŒ"

      # âœ… 14. Python ì„œë¹„ìŠ¤ ìƒíƒœ í™•ì¸
      - name: ğŸ§ª Flask ì„œë²„ ìƒíƒœ ì ê²€
        uses: appleboy/ssh-action@master
        with:
          host: ${{ secrets.EC2_HOST }}
          username: ${{ secrets.EC2_USER }}
          key: ${{ secrets.EC2_KEY }}
          script: |
            echo "ğŸ“¡ python.service ìƒíƒœ í™•ì¸"
            sudo systemctl status python.service --no-pager
